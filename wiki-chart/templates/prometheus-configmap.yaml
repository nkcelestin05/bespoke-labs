# ============================================================================
# Prometheus ConfigMap
# ============================================================================
# This ConfigMap contains the Prometheus configuration file (prometheus.yml)
# which defines how Prometheus should collect metrics.
#
# Key Concepts:
# - Scrape Configs: Define what endpoints to collect metrics from
# - Static Configs: Manually specify target addresses (vs service discovery)
# - Metrics Path: The HTTP endpoint where metrics are exposed
# - Scrape Interval: How often to collect metrics (from values.yaml)
#
# This configuration enables:
# 1. FastAPI metrics collection from /metrics endpoint
# 2. Self-monitoring (Prometheus monitoring itself)
# ============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wiki-chart.fullname" . }}-prometheus-config
  labels:
    {{- include "wiki-chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitoring
data:
  # prometheus.yml: Main Prometheus configuration file
  # This file is mounted into the Prometheus container at /etc/prometheus/
  prometheus.yml: |
    # Global configuration applied to all scrape jobs
    global:
      # scrape_interval: How often to scrape targets for metrics
      # Default: 15 seconds (4 times per minute)
      # Trade-off: Lower = more current data but higher resource usage
      scrape_interval: {{ .Values.prometheus.scrapeInterval }}
      
      # evaluation_interval: How often to evaluate recording/alerting rules
      # We don't have rules yet, but this prepares for Phase 10+
      evaluation_interval: {{ .Values.prometheus.evaluationInterval }}
      
    # Rule files: Where Prometheus loads alerting rules (Phase 10)
    rule_files:
      - 'alert_rules.yml'
    
{{- if .Values.alertmanager.enabled }}
    # Alerting configuration: Send firing alerts to Alertmanager
    alerting:
      alertmanagers:
        - static_configs:
            - targets: ['{{ include "wiki-chart.fullname" . }}-alertmanager:{{ .Values.alertmanager.service.port | default 9093 }}']
    {{- end }}
    
    # Scrape configurations: Define what endpoints to monitor
    scrape_configs:
      # ========================================================================
      # Job 1: FastAPI Application Monitoring
      # ========================================================================
      # This job scrapes metrics from our FastAPI application
      - job_name: 'fastapi'
        
        # static_configs: Manually specify target addresses
        # Alternative: kubernetes_sd_configs for automatic service discovery
        static_configs:
          # Target format: service-name:port
          # Uses Kubernetes internal DNS: <service>.<namespace>.svc.cluster.local
          # Short form works within same namespace: <service>:<port>
          - targets: ['{{ include "wiki-chart.fullname" . }}-fastapi:{{ .Values.fastapi.service.port }}']
        
        # metrics_path: HTTP endpoint where metrics are exposed
        # FastAPI application exposes Prometheus metrics at /metrics
        metrics_path: '/metrics'
        
        # What Prometheus will scrape:
        # - users_created_total: Counter of users created
        # - posts_created_total: Counter of posts created
        # - Python runtime metrics (memory, CPU, etc.)
      
      # ========================================================================
      # Job 2: Prometheus Self-Monitoring
      # ========================================================================
      # Prometheus monitors its own health and performance
      # This is a best practice for any monitoring system
      - job_name: 'prometheus'
        
        static_configs:
          # Target: localhost:9090 (Prometheus itself)
          - targets: ['localhost:9090']
        
        # What this provides:
        # - prometheus_build_info: Version and build information
        # - prometheus_tsdb_*: Time-series database metrics
        # - prometheus_http_requests_total: API request counts
        # - go_*: Go runtime metrics (memory, goroutines, etc.)
  
  # Alerting rules file: Prometheus loads these from the mounted config
  alert_rules.yml: |
    groups:
    - name: fastapi-alerts
      rules:
      - alert: FastAPIDown
        expr: up{job="fastapi"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "FastAPI target is down (job={{`{{ $labels.job }}`}})"
          description: "FastAPI job is down for more than 2 minutes"

    - name: prometheus-alerts
      rules:
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus itself is down"
          description: "Prometheus target is down"

      - alert: PrometheusHighMemory
        expr: process_resident_memory_bytes{job="prometheus"} > 200000000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus high memory usage"
          description: "Prometheus memory > 200MB for >5m"
